<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>コード解析とクイズ生成</title>
</head>

<body>
    <h1>コード解析とクイズ生成</h1>

    <div id="quiz-container">
        <!-- 生成されたクイズがここに表示されます -->
    </div>
    <button id="next-button" style="display:none;">次へ</button>

    <script type="module">
        import Parser from 'https://unpkg.com/tree-sitter';
        import CPP from 'https://unpkg.com/tree-sitter-wasms/out/tree-sitter-cpp.wasm';

        let currentQuestionIndex = 0;
        let questions = [];
        let parser = new Parser();

        // Tree-sitterの初期化
        async function initializeParser() {
            const language = await Parser.Language.load(CPP);
            parser.setLanguage(language);
        }

        // サブモジュール内のコードファイルを読み込んで解析する
        async function fetchAndParseCode() {
            const response = await fetch('./robocon2024-national/src/controller/main.cpp'); // C++ファイルの例
            const code = await response.text();

            // Tree-sitterを使って解析する
            const tree = parser.parse(code);
            return tree;
        }

        // 解析結果からC++の変数宣言を抽出する
        function extractVariables(node) {
            const variables = [];

            // 再帰的にノードを探索して変数宣言を探す
            function traverse(node) {
                if (node.type === 'variable_declarator') {
                    const varType = node.parent.child(0).text;
                    const varName = node.child(0).text;
                    const varValue = node.child(1) ? node.child(1).text : null;
                    variables.push({ type: varType, name: varName, value: varValue });
                }

                for (let i = 0; i < node.childCount; i++) {
                    traverse(node.child(i));
                }
            }

            traverse(node.rootNode);
            return variables;
        }

        // 配列をランダムにシャッフルする関数
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 問題を生成する
        function generateQuestion(variable) {
            const correctOption = `${variable.type} 型の変数 ${variable.name} を宣言し、${variable.value} で初期化している。`;
            const options = [
                correctOption,
                `${variable.name} 型の変数 ${variable.type} を宣言し、${variable.value} で初期化している。`,
                `${variable.value} 型の変数 ${variable.name} を宣言し、${variable.type} で初期化している。`,
                `${variable.value} 型の変数 ${variable.type} を宣言し、${variable.name} で初期化している。`
            ];

            // 選択肢をシャッフル
            const shuffledOptions = shuffleArray(options);

            return `<p>次の変数宣言 '${variable.name}' に関する文法的な問題を選択してください。</p><ul>${shuffledOptions.map((opt, index) => `<li>${String.fromCharCode(97 + index)}. ${opt}</li>`).join('')}</ul>`;
        }

        // 現在の問題を表示する
        function showQuestion() {
            if (currentQuestionIndex < questions.length) {
                const quizContainer = document.getElementById('quiz-container');
                quizContainer.innerHTML = questions[currentQuestionIndex];
                document.getElementById('next-button').style.display = 'block';
            } else {
                document.getElementById('quiz-container').innerHTML = '<p>全ての問題が終了しました。</p>';
                document.getElementById('next-button').style.display = 'none';
            }
        }

        // クイズをページに表示する
        async function displayQuiz() {
            await initializeParser();
            const tree = await fetchAndParseCode();
            const variables = extractVariables(tree);
            questions = variables.map(generateQuestion);
            showQuestion();
        }

        // 「次へ」ボタンのクリックイベント
        document.getElementById('next-button').addEventListener('click', () => {
            currentQuestionIndex++;
            showQuestion();
        });

        // ページ読み込み時にクイズを表示
        window.onload = displayQuiz;
    </script>
</body>

</html>