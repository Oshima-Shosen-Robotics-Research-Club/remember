<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>覚えて学ぶC++</title>
</head>

<body>
    <h1>覚えて学ぶC++</h1>

    <div id="loading" style="display:none;">ローディング中...</div>
    <div id="quiz-container">
        <!-- 生成されたクイズがここに表示されます -->
    </div>
    <button id="check-button" style="display:none;">採点</button>
    <button id="next-button" style="display:none;">次へ</button>

    <!-- URL選択セクション -->
    <div id="code-selection">
        <label for="code-url">コードを選んでください:</label>
        <select id="code-url">
            <option
                value="https://raw.githubusercontent.com/Oshima-Shosen-Robotics-Research-Club/robocon2024-national/refs/heads/stable/src/controller/main.cpp">
                robocon2024 - controller/main.cpp
            </option>
            <option
                value="https://raw.githubusercontent.com/Oshima-Shosen-Robotics-Research-Club/robocon2024-national/refs/heads/stable/src/robot/main.cpp">
                robocon2024 - robot/main.cpp
            </option>
            <option
                value="https://raw.githubusercontent.com/Oshima-Shosen-Robotics-Research-Club/Tutorial/refs/heads/main/src/controller/main.cpp">
                Tutorial - controller/main.cpp
            </option>
            <option
                value="https://raw.githubusercontent.com/Oshima-Shosen-Robotics-Research-Club/Tutorial/refs/heads/main/src/robot/main.cpp">
                Tutorial - robot/main.cpp
            </option>
        </select>
        <button id="start-quiz-button">クイズを開始</button>
    </div>

    <script src="https://unpkg.com/web-tree-sitter/tree-sitter.js"></script>
    <script type="module">
        let currentQuestionIndex = 0;
        let questions = [];
        let parser;
        let score = 0;

        async function initializeParser() {
            console.log("Initializing parser...");
            await TreeSitter.init();
            parser = new TreeSitter();
            const Lang = await TreeSitter.Language.load('https://unpkg.com/tree-sitter-wasms/out/tree-sitter-cpp.wasm');
            console.log("Language loaded:", Lang);
            parser.setLanguage(Lang);
            console.log("Parser initialized:", parser);
        }

        async function fetchAndParseCode(url) {
            console.log("Fetching and parsing code from:", url);
            const response = await fetch(url);
            const code = await response.text();
            console.log("Code fetched:\n", code);

            const tree = parser.parse(code);
            console.log("Code parsed:", tree);
            return tree;
        }

        function createNodeArray(node) {
            const nodeArray = [];
            function traverse(node, indent = 0) {
                console.log(' '.repeat(indent * 2), `type: ${node.type}, text: ${node.text}`);
                nodeArray.push(node);
                for (let i = 0; i < node.childCount; i++) {
                    traverse(node.child(i), indent + 1);
                }
            }
            traverse(node);
            return nodeArray;
        }

        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        function parseTextFromNode(node) {
            const comments = node.children.filter(node => node.type === 'comment').map(node => node.text);
            return node.text.replace(comments, '').replace(/>/g, '&gt;').replace(/</g, '&lt;');
        }

        function createIncQuestion(node) {
            if (node.type !== 'preproc_include') {
                return null;
            }

            const program = parseTextFromNode(node);
            const question = `次の #include の "" や <> を見て、『どこからプログラムを取得しているか』を選んでください。<br>${program}`;
            const correctNum = 0;

            let options = [];
            let correctOption = '';

            if (node.child(1).type === 'system_lib_string') {
                correctOption = '『標準のライブラリがあるフォルダ』または『プロジェクト直下』からプログラムを取得している。';
                options.push('『インクルードを行っているファイルが位置するフォルダから見て、プログラムを取得している。');
            } else {
                correctOption = '『インクルードを行っているファイルが位置するフォルダ』からプログラムを取得している。';
                options.push('『標準のライブラリがあるフォルダ』または『プロジェクト直下』からプログラムを取得している。');
            }

            options.push(correctOption);
            options = shuffleArray(options);

            return {
                question: question,
                correctNum: options.indexOf(correctOption),
                options: options,
            };
        }

        function createDefQuestion(node) {
            if (node.type !== 'preproc_def') {
                return null;
            }

            const program = parseTextFromNode(node);
            const question = `次の #define の意味を選んでください。<br>${program}`;
            const correctNum = 0;

            let options = [];
            let correctOption = `${parseTextFromNode(node.child(1))} という値を、${parseTextFromNode(node.child(2))} という名前で扱えるようにする。`;
            options.push(`${parseTextFromNode(node.child(2))} という値を、${parseTextFromNode(node.child(1))} という名前で扱えるようにする。`);

            options.push(correctOption);
            options = shuffleArray(options);

            return {
                question: question,
                correctNum: options.indexOf(correctOption),
                options: options,
            };
        }

        function showQuestion() {
            if (currentQuestionIndex < questions.length) {
                const quizContainer = document.getElementById('quiz-container');
                quizContainer.innerHTML = '<h2>問題</h2>';
                quizContainer.innerHTML += questions[currentQuestionIndex].question;
                quizContainer.innerHTML += '<p>選択肢を選んでください。</p>';
                quizContainer.innerHTML += questions[currentQuestionIndex].options.map((opt, index) => `<input type="radio" name="option" value="${index}">${opt}<br>`).join('');
                document.getElementById('next-button').style.display = 'none';
                document.getElementById('check-button').style.display = 'block';
            } else {
                document.getElementById('quiz-container').innerHTML = `<p>全ての問題が終了しました。あなたのスコアは ${score} / ${questions.length} です。</p>`;
                document.getElementById('next-button').style.display = 'none';
                document.getElementById('check-button').style.display = 'none';
            }
        }

        async function displayQuiz(url) {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('code-selection').style.display = 'none'; // コード選択セクションを非表示にする
            await initializeParser();
            const tree = await fetchAndParseCode(url);
            const nodes = createNodeArray(tree.rootNode);
            const incQuestions = nodes.map(createIncQuestion).filter(q => q !== null);
            const defQuestions = nodes.map(createDefQuestion).filter(q => q !== null);
            questions.push(...incQuestions);
            questions.push(...defQuestions);
            questions = shuffleArray(questions);
            document.getElementById('loading').style.display = 'none';
            showQuestion();
        }

        document.getElementById('start-quiz-button').addEventListener('click', () => {
            const selectedUrl = document.getElementById('code-url').value;
            currentQuestionIndex = 0;
            score = 0;
            questions = [];
            displayQuiz(selectedUrl);
        });

        document.getElementById('next-button').addEventListener('click', () => {
            currentQuestionIndex++;
            showQuestion();
        });

        document.getElementById('check-button').addEventListener('click', () => {
            const selectedOption = document.querySelector('input[name="option"]:checked');
            const resultMessage = document.createElement('p');
            if (selectedOption) {
                const selectedValue = parseInt(selectedOption.value, 10);
                if (selectedValue === questions[currentQuestionIndex].correctNum) {
                    score++;
                    resultMessage.textContent = '正解です！';
                } else {
                    const correctAnswer = questions[currentQuestionIndex].options[questions[currentQuestionIndex].correctNum];
                    resultMessage.textContent = `不正解です。正解は ${correctAnswer} です。`;
                }
            } else {
                alert('選択肢を選んでください。');
                return;
            }
            document.getElementById('quiz-container').appendChild(resultMessage);
            document.getElementById('check-button').style.display = 'none';
            document.getElementById('next-button').style.display = 'block';
        });
    </script>
</body>

</html>