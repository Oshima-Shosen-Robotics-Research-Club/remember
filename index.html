<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>コード解析とクイズ生成</title>
</head>

<body>
    <h1>コード解析とクイズ生成</h1>

    <div id="quiz-container">
        <!-- 生成されたクイズがここに表示されます -->
    </div>
    <button id="next-button" style="display:none;">次へ</button>

    <script src="https://unpkg.com/web-tree-sitter/tree-sitter.js"></script>
    <script type="module">
        let currentQuestionIndex = 0;
        let questions = [];
        let parser;

        // Tree-sitterの初期化
        async function initializeParser() {
            console.log("Initializing parser...");
            await TreeSitter.init();
            parser = new TreeSitter();
            const Lang = await TreeSitter.Language.load('https://unpkg.com/tree-sitter-wasms/out/tree-sitter-cpp.wasm');
            console.log("Language loaded:", Lang);
            parser.setLanguage(Lang);
            console.log("Parser initialized:", parser);
        }

        // サブモジュール内のコードファイルを読み込んで解析する
        async function fetchAndParseCode() {
            console.log("Fetching and parsing code...");
            const response = await fetch('https://raw.githubusercontent.com/Oshima-Shosen-Robotics-Research-Club/robocon2024-national/refs/heads/stable/src/robot/main.cpp'); // C++ファイルの例
            const code = await response.text();
            console.log("Code fetched:", code);

            // Tree-sitterを使って解析する
            const tree = parser.parse(code);
            console.log("Code parsed:", tree);
            console.log("Root node:", tree.rootNode); // 追加: ルートノードのログ出力
            return tree;
        }

        // 解析結果からC++の変数宣言を抽出する
        function extractVariables(node) {
            console.log("Extracting variables...");
            const variables = [];

            // 再帰的にノードを探索して変数宣言を探す
            function traverse(node) {
                console.log("Traversing node:", node.type);
                if (node.type === 'variable_declarator') {
                    const varType = node.parent.child(0).text;
                    const varName = node.child(0).text;
                    const varValue = node.child(1) ? node.child(1).text : null;
                    variables.push({ type: varType, name: varName, value: varValue });
                }

                for (let i = 0; i < node.childCount; i++) {
                    traverse(node.child(i));
                }
            }

            traverse(node);
            console.log("Variables extracted:", variables);
            return variables;
        }

        // 配列をランダムにシャッフルする関数
        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]];
            }
            return array;
        }

        // 問題を生成する
        function generateQuestion(variable) {
            const correctOption = `${variable.type} 型の変数 ${variable.name} を宣言し、${variable.value} で初期化している。`;
            const options = [
                correctOption,
                `${variable.name} 型の変数 ${variable.type} を宣言し、${variable.value} で初期化している。`,
                `${variable.value} 型の変数 ${variable.name} を宣言し、${variable.type} で初期化している。`,
                `${variable.value} 型の変数 ${variable.type} を宣言し、${variable.name} で初期化している。`
            ];

            // 選択肢をシャッフル
            const shuffledOptions = shuffleArray(options);

            return `<p>次の変数宣言 '${variable.name}' に関する文法的な問題を選択してください。</p><ul>${shuffledOptions.map((opt, index) => `<li>${String.fromCharCode(97 + index)}. ${opt}</li>`).join('')}</ul>`;
        }

        // 現在の問題を表示する
        function showQuestion() {
            console.log("Showing question...");
            if (currentQuestionIndex < questions.length) {
                const quizContainer = document.getElementById('quiz-container');
                quizContainer.innerHTML = questions[currentQuestionIndex];
                document.getElementById('next-button').style.display = 'block';
            } else {
                document.getElementById('quiz-container').innerHTML = '<p>全ての問題が終了しました。</p>';
                document.getElementById('next-button').style.display = 'none';
            }
        }

        // クイズをページに表示する
        async function displayQuiz() {
            console.log("Displaying quiz...");
            await initializeParser();
            const tree = await fetchAndParseCode();
            const variables = extractVariables(tree.rootNode);
            questions = variables.map(generateQuestion);
            console.log("Questions generated:", questions);
            showQuestion();
        }

        // 「次へ」ボタンのクリックイベント
        document.getElementById('next-button').addEventListener('click', () => {
            currentQuestionIndex++;
            showQuestion();
        });

        // ページ読み込み時にクイズを表示
        window.onload = displayQuiz;
    </script>
</body>

</html>